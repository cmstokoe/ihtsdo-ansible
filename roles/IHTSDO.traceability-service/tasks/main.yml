---
#Legacy install removial

- name: Stop any running instances
  supervisorctl: name=traceability-service  state=stopped  
  failed_when: false

- name: Blow away any previous version
  command: rm -rf /opt/traceability-service

- name: Blow away stale supervisorctl conf
  command: rm -rf /etc/supervisor/conf.d/traceability-service.conf

#End of legacy

- name: Stop any running instances
  supervisorctl: name={{ traceability_name }}  state=stopped  
  failed_when: false

- name: Create a new database if required
  mysql_db: name={{ traceability_database }} state=present login_user=root login_password={{ mysql_root_pass }} encoding=utf8

- name: Creates the database user if required
  mysql_user: name={{ traceability_database_username }} password={{ traceability_database_password }} login_user=root login_password={{ mysql_root_pass }} priv=*.*:ALL,GRANT state=present

- name: Install package
  apt: name={{ traceability_name }} state=installed force=yes update_cache=yes
  when: traceability_version == 'present'

- name: Install package
  apt: name={{ traceability_name }} state=installed force=yes update_cache=yes
  when: traceability_version == 'absent'

- name: Install latest package
  apt: name={{ traceability_name }} state=latest force=yes update_cache=yes
  when: traceability_version == 'latest'

- name: Install package specific version
  apt: name={{ traceability_name }}={{ traceability_version }} state=installed force=yes
  when: traceability_version != 'installed' and traceability_version != 'latest' and traceability_version != 'absent'

- name: Copy application.properties
  template: src=application.properties.j2 dest=/opt/{{ traceability_name }}/application.properties owner=root group=root mode=0644

- name: (re)start traceability-service
  supervisorctl: name={{ traceability_name }}  state=restarted
