---
- name: Apt cache update
  apt: update_cache=yes 
  tags:
    - ihtsdo-asset
    
#Setup the database
- include: db.yml

- name: Stop TS if running
  supervisorctl: name=termserver state=stopped

- name: Install term server
  apt: pkg=termserver state=latest force=yes
  
- name: Make sure all .sh files in bin are executable
  shell:  'find {{term_serv_dir}}/bin -name "*.sh" -exec chmod +x {} \;'  


#Setup the backup 
- include: backup.yml

#If setting up the content
#- include: setdbcontent.yml
#  when: "set_db_content == True"

# set the my.cnf
- name: Copy crowd.properties
  template: src=crowd.properties.j2 dest={{ term_serv_conf_dir }}/crowd.properties owner=root group=root mode=0644  
  
# set the my.cnf
- name: Copy single_authoring.properties
  template: src=single_authoring.properties.j2 dest={{ term_serv_conf_dir }}/single_authoring.properties owner=root group=root mode=0644    
  
- name: Copy setenv.sh
  template: src=setenv.sh dest={{ term_serv_dir }}/bin/setenv.sh owner=root group=root mode=0755

- name: Copy Jira Private Key
  copy: src={{ jira_pem_file }} dest={{ term_serv_conf_dir }}/jira.pem
        owner=root group=root mode=0644

- name: Start TS
  supervisorctl: name=termserver state=started



