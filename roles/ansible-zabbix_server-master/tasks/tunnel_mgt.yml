---

- name: tunnel_mgt | apt install autossh 
  apt: pkg="{{item}}" 
  with_items:
     - autossh
  tags: tunnel_mgt

- name: tunnel_mgt | Create tunnel user - forward only no shell
  user: 
    name="{{zabbixserver_tunnel_user}}"
    home="{{zabbixserver_tunnel_home}}"
    shell="/bin/false" 
    append="True"
    comment="tunnel user" 
    force="yes"  
  tags: tunnel_mgt
  notify: restart assh

- name: tunnel_mgt | Create assh directory
  file: 
     dest="{{item}}/"
     owner="{{zabbixserver_tunnel_user}}"
     mode=0755
     state=directory
  with_items:
     - "{{zabbixserver_tunnel_basedir}}"
     - "{{zabbixserver_tunnel_etc}}"
     - "{{zabbixserver_tunnel_basedir}}/keys"
     - "{{zabbixserver_tunnel_basedir}}/logs"
     - "{{zabbixserver_tunnel_basedir}}/var"
     - "{{zabbixserver_tunnel_basedir}}/var/lock"
     - "{{zabbixserver_tunnel_basedir}}/var/lock/subsys"
     - "{{zabbixserver_tunnel_basedir}}/var/run"
     - "{{zabbixserver_tunnel_basedir}}/var/run/autossh"
  tags: tunnel_mgt

- name: tunnel_mgt | Deploy assh binary
  template: 
     src=assh/assh.j2
     dest="{{zabbixserver_tunnel_bin}}"
     owner="{{zabbixserver_tunnel_user}}"     
     mode=0755
  tags: tunnel_mgt
  notify: restart assh

- name: tunnel_mgt | Deploy support functions file
  template: 
     src=assh/functions.j2
     dest="{{zabbixserver_tunnel_basedir}}/functions"
     owner="{{zabbixserver_tunnel_user}}"     
     mode=0755
  tags: tunnel_mgt
  notify: restart assh

- name: tunnel_mgt | Create service autossh link
  file: 
     src="{{zabbixserver_tunnel_bin}}"
     dest="/etc/init.d/assh"
     owner=root
     group=root
     state=link
  tags: tunnel_mgt

