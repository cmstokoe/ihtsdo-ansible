---
#Create the default user
- name: Ensure {{ atlassian_application }} group exists
  group: name={{ system_group }}  state=present system=yes

- name: Ensure {{ atlassian_application }} user exists
  user: name={{ system_user }} group={{ system_group }} state=present system=yes

#Create installation dir
- name: Create {{ atlassian_application }} installation directory
  file: path={{ common_install }} state=directory owner={{ system_user }}  group={{ system_group }}

- name: Set download_location
  set_fact: 
     package: "{{ atlassian_archive }}"

- name: Overide standard download location for jira 7
  set_fact:
     package: "atlassian-jira-software-{{ atlassian_version }}-jira-{{ atlassian_version }}.tar.gz"
  when: atlassian_application  == 'jira' and {{ atlassian_version | version_compare('7.0.0', '>=') }}

#Download and Extract the source
- name: Download and Extract Application
  unarchive: src="{{ common_download_location }}/{{ package }}" dest={{ common_install }} owner={{ system_user }}  group={{ system_group }} copy=no

- shell: ls -d {{ common_install }}/atlassian-{{ atlassian_application }}*
  register: full_path

#Rename installation directory
- name: Make the installed path version neutral
  command: mv {{ item }} {{ common_install }}/{{ atlassian_application }}
  with_items: "{{ full_path.stdout_lines }}"

#Create home dir
- name: Create home directory
  file: path={{ common_home }}/{{ atlassian_application }} state=directory owner={{ system_user }}  group={{ system_group }}
