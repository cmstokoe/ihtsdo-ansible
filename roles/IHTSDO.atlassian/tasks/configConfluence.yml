---
#Update config file
- name: Set Confluence home dir in init properties
  lineinfile:
      dest="{{ common_install }}/confluence/confluence/WEB-INF/classes/confluence-init.properties"
      regexp="confluence.home="
      line="confluence.home={{ common_home }}/confluence"

#Use confluence user
- name: Set default user for confluence
  lineinfile:
     dest="{{ common_install }}/confluence/bin/user.sh"
     regexp="^CONF_USER="
     line="CONF_USER={{ system_user }}"

- name: Create default database user for application
  mysql_user: name={{ mysql_user }} password={{ mysql_password }} login_user=root login_password={{ mysql_root_password }} priv=*.*:ALL,GRANT state=present

# Create the database
- name: Create default database
  mysql_db: name={{mysql_db}} login_user={{mysql_user}} login_password={{mysql_password}} encoding=utf8 state=present

- name: Add innodb_log_file_size = 1024M to my.cnf
  lineinfile:
     dest="/etc/mysql/my.cnf"
     insertafter="\[mysqld\]"
     line="innodb_log_file_size = 1024M"


- name: Add innodb_buffer_pool_size = 2G to my.cnf
  lineinfile:
     dest="/etc/mysql/my.cnf"
     insertafter="\[mysqld\]"
     line="innodb_buffer_pool_size = 2G"

- name:  Modify max_allowed_packet mysqldump settings in my.cnf
  lineinfile:
     dest="/etc/mysql/my.cnf"
     regexp="^max_allowed_packet	"
     line="max_allowed_packet = 1G"

- name:  Modify max_allowed_packet server  settings in my.cnf
  lineinfile:
     dest="/etc/mysql/my.cnf"
     regexp="^max_allowed_packet	"
     line="max_allowed_packet = 1G"

- name: Ensure service is started
  service: name=mysql  state=restarted
